<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”« ìë°”ìŠ¤í¬ë¦½íŠ¸ ë£°ë › ê²Œì„ (ì›¨ì´ë¸Œ ì‹œìŠ¤í…œ) ğŸ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ í…Œë§ˆ ë° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* ì§„í•œ ë¸”ë™ ë°°ê²½ */
            color: #e5e7eb; /* ë°ì€ íšŒìƒ‰ ê¸€ì”¨ */
            margin: 0;
            min-height: 100vh;
        }
        .item-card {
            width: 130px; /* ê³ ì • í¬ê¸° ìœ ì§€ */
            height: 180px;
            min-width: 130px;
            min-height: 180px;
            background-color: #2c2c2c;
            border: 2px solid #3d3d3d;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .item-card:hover:not(.empty) {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }
        .item-card.empty {
            opacity: 0.3;
            border-style: dashed;
            cursor: default;
            background-color: #1f1f1f;
            box-shadow: none;
            transform: none;
        }
        /* ì•„ì´í…œ ì»¨í…Œì´ë„ˆ: 4x2 ê²©ì ë ˆì´ì•„ì›ƒì„ ê°•ì œí•˜ì—¬ ì¼ê´€ì„±ì„ ë†’ì…ë‹ˆë‹¤. */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); /* ìµœì†Œ 110px */
            gap: 1rem;
            justify-content: center;
        }
        /* ëª¨ë°”ì¼ í™˜ê²½ì—ì„œëŠ” 3ì—´ê¹Œì§€ë§Œ í—ˆìš©í•˜ì—¬ ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€ */
        @media (max-width: 768px) {
            .item-grid {
                grid-template-columns: repeat(3, minmax(100px, 1fr));
            }
            .item-card {
                width: 100%; /* ëª¨ë°”ì¼ì—ì„œ ë„ˆë¹„ ì±„ìš°ê¸° */
                height: 160px;
                min-width: 100px;
            }
        }

        .game-output { max-height: 480px; } /* ë†’ì´ ì œí•œ ì¶”ê°€ */
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .game-output::-webkit-scrollbar { width: 8px; }
        .game-output::-webkit-scrollbar-thumb { background-color: #4a4; border-radius: 4px; }
        .game-output::-webkit-scrollbar-track { background: #2c2c2c; }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold text-center text-red-500 mb-6 border-b border-gray-700 pb-3">
        ğŸ”« ë£°ë › ê²Œì„ ğŸ² (ì›¨ì´ë¸Œ ì‹œìŠ¤í…œ)
    </h1>

    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2 text-gray-400">
            ğŸ¤– ë”œëŸ¬ ì•„ì´í…œ (HP: <span id="dealer-hp" class="text-red-400 font-bold">?</span>)
        </h2>
        <div id="dealer-items-container" class="item-grid p-4 rounded-lg bg-gray-800 shadow-xl">
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-1 bg-gray-800 p-4 rounded-lg shadow-xl order-2 lg:order-1">
            <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3">í˜„ì¬ ìƒíƒœ</h3>
            <p id="current-round" class="mb-2 text-purple-300">ì›¨ì´ë¸Œ: ?</p>
            <p id="current-turn" class="mb-2 text-yellow-300">í„´: ?</p>
            <p id="magazine-status" class="mb-2">íƒ„ì°½: ?</p>
            <p id="known-next-shot" class="mb-2">ë‹¤ìŒ íƒ„í™˜ ì •ë³´: ?</p>
            <p id="active-effects" class="text-sm text-blue-400">í™œì„±í™”ëœ íš¨ê³¼: ì—†ìŒ</p>
        </div>

        <div class="lg:col-span-2 bg-gray-900 p-4 rounded-lg shadow-inner border border-gray-700 order-1 lg:order-2">
            <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3">ê²Œì„ ê¸°ë¡</h3>
            <div class="game-output text-sm h-64 overflow-y-auto" id="output">
                ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ 'ê²Œì„ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
            </div>

            <div id="controls-shot" class="flex flex-wrap justify-center gap-4 p-3 mt-4 bg-gray-800 rounded-lg">
            </div>
        </div>
    </div>

    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2 text-gray-400">
            ğŸ˜ í”Œë ˆì´ì–´ ì•„ì´í…œ (HP: <span id="player-hp" class="text-green-400 font-bold">?</span>)
        </h2>
        <div id="player-items-container" class="item-grid p-4 rounded-lg bg-gray-800 shadow-xl">
        </div>
    </div>

    <div id="controls-start" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-700 rounded-lg shadow-2xl">
        <button onclick="GameModule.startGame()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200">
            ê²Œì„ ì‹œì‘
        </button>
    </div>

</div>

<script>
    // ===============================================
    // ğŸ’¡ GameModule: ëª¨ë“  ê²Œì„ ë¡œì§ì„ ìº¡ìŠí™”í•˜ì—¬ ëª¨ë“ˆí™”í•©ë‹ˆë‹¤.
    // ===============================================
    const GameModule = (() => {
        // --- 1. DOM ìš”ì†Œ ìºì‹± ---
        const outputElement = document.getElementById('output');
        const dealerItemsContainer = document.getElementById('dealer-items-container');
        const playerItemsContainer = document.getElementById('player-items-container');
        const controlsShotElement = document.getElementById('controls-shot'); // ì‚¬ê²© ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const controlsStartElement = document.getElementById('controls-start'); // ì‹œì‘ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ

        // --- 2. ìƒíƒœ ê°ì²´ ë° ìƒìˆ˜ ---
        let gameState = {
            playerHP: 0,
            dealerHP: 0,
            playerItems: [],
            dealerItems: [],
            magazine: [], // [true, false, true, false, ...] (true: ì‹¤íƒ„, false: ê³µí¬íƒ„)
            knownNextShot: null,
            turn: 'start', // 'start', 'player', 'dealer', 'end'
            currentPage: 0, // í˜„ì¬ ë¼ìš´ë“œ ë²ˆí˜¸ (0: ì‹œì‘ ì „)
            totalTurns: 0,
            playerProtected: false,
            dealerProtected: false,
            playerSawActive: false,
            dealerSawActive: false,
            dealerSkipNextTurn: false,
            playerSkipNextTurn: false,
            playerDamageFixToOne: false,
            dealerDamageFixToOne: false,
            playerDamageAddOne: false,
            dealerDamageAddOne: false,
            knownBulletInfo: [],
            playerDrunkSkip: false,
            dealerDrunkSkip: false,
            playerFuseActive: false,
            dealerFuseActive: false,
            selectedPerk: null, // íŠ¹ìˆ˜ëŠ¥ë ¥..
        };

        const PERKS = {
            "LastSupper": {
                name: "ìµœí›„ì˜ ë§Œì°¬ ğŸ·",
                description: "ê²Œì„ ì‹œì‘ ì‹œ HP ë¥¼ 1 ëŠ˜ë¦½ë‹ˆë‹¤."
            },
            "LuckyPouch": {
                name: "í–‰ìš´ì˜ ì£¼ë¨¸ë‹ˆ ğŸ€",
                description: "ì›¨ì´ë¸Œ ì‹œì‘ ì‹œ ì•„ì´í…œì„ 1ê°œ ë” ë°›ìŠµë‹ˆë‹¤."
            },
            "BlessedMagazine": {
                name: "ì¶•ë³µë°›ì€ íƒ„ì°½ âœ¨",
                description: "ì›¨ì´ë¸Œ ì‹œì‘ ì‹œ, ì²« íƒ„í™˜ì€ ë¬´ì¡°ê±´ ê³µí¬íƒ„ì…ë‹ˆë‹¤."
            },
            // ê·¸ ì™¸ ì¶”ê°€í•  ê²ƒ
        };

        const ITEM_EFFECTS = {
            "í™•ëŒ€ê²½": "ë‹¤ìŒ íƒ„í™˜ í™•ì¸.",
            "ìˆ˜ê°‘": "ìƒëŒ€ ë‹¤ìŒ í„´ ìŠ¤í‚µ.",
            "ë‹´ë°°": "HP +1 íšŒë³µ.",
            "ì‡ í†±": "ë‹¤ìŒ ì‚¬ê²© í”¼í•´ 2ë°°.",
            "ë°©íƒ„ë³µ": "ìƒëŒ€ ê³µê²© 1íšŒ ë¬´íš¨.",
            "ì£¼ì‚¬ê¸°": "ìƒëŒ€ ì•„ì´í…œ 1ê°œ í›”ì¹˜ê¸°.",
            "ë‚˜ì´í”„": "ìƒëŒ€ HP 1 ê°ì†Œ.",
            "ì†í†±": "ì• íƒ„í™˜ ê°•ì œ ë°°ì¶œ.",
            "ë§¥ì£¼": "ë’¤ íƒ„í™˜ ê°•ì œ ë°°ì¶œ.",
            "ë¶€ì ": "ë‹¤ìŒ í”¼í•´ë¥¼ 1ë¡œ ê³ ì •.",
            "í­íƒ„": "ìƒëŒ€ 2, ìì‹  1 í”¼í•´.",
            "íœ´ëŒ€í°": "í˜„ì¬ ì¥ì „ëœ íƒ„í™˜ì˜ Xë²ˆì§¸ íƒ„í™˜ì„ í™•ì¸í•©ë‹ˆë‹¤.",
            "ì•½": "50% í™•ë¥ ë¡œ 2 HPë¥¼ ì–»ê±°ë‚˜ 1 HP ë¥¼ ìƒìŠµë‹ˆë‹¤.",
            "ë™ì „": "70% í™•ë¥ ë¡œ +1 ëŒ€ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, 30% í™•ë¥ ë¡œ 1 HPë¥¼ ìƒìŠµë‹ˆë‹¤.",
            "ëˆˆì•Œ": "ìì‹ ì˜ HPë¥¼ 1 ìƒê³  2ê°œì˜ ì•„ì´í…œ íšë“.",
            "ìˆ ": "HPë¥¼ 2 íšŒë³µí•˜ê³ , ë‹¤ìŒ í„´ ìŠ¤í‚µ.",
            "ë‹¹ì²¨ëœë³µê¶Œ": "50% í™•ë¥ ë¡œ ìƒëŒ€ 1 í”¼í•´ ë˜ëŠ” ì•„ì´í…œ 1ê°œ íšë“.",
            "ë¯¸ë‹ˆì—ì–´ì»¨": "í˜„ì¬ íƒ„í™˜ ìˆœì„œë¥¼ ë’¤ì§‘ìŒ.",
            "ë„í™”ì„ ": "ìƒëŒ€ë°©ì˜ í­íƒ„ ì•„ì´í…œì„ ë¬´íš¨í™” ì‹œí‚µë‹ˆë‹¤.",
            "íŠ¸ë¦­ë°•ìŠ¤": "30% í™•ë¥ ë¡œ ìƒëŒ€ë°©ê³¼ ìì‹ ì˜ ì²´ë ¥ì„ ë’¤ë°”ê¿‰ë‹ˆë‹¤. 70% í™•ë¥ ë¡œ HP-2 í”¼í•´ë¥¼ ì…ìŠµë‹ˆë‹¤."
        };

        const ITEM_ICONS = { // UI ë Œë”ë§ì— ì‚¬ìš©ë˜ëŠ” ì•„ì´ì½˜
            "í™•ëŒ€ê²½": "ğŸ”", "ìˆ˜ê°‘": "ğŸ”—", "ë‹´ë°°": "ğŸš¬", "ì‡ í†±": "ğŸªš", "ë°©íƒ„ë³µ": "ğŸ›¡ï¸",
            "ì£¼ì‚¬ê¸°": "ğŸ’‰", "ë‚˜ì´í”„": "ğŸ”ª", "ì†í†±": "ğŸ’…", "ë§¥ì£¼": "ğŸº",
            "ë¶€ì ": "âœ¨", "í­íƒ„": "ğŸ’¥", "íœ´ëŒ€í°": "ğŸ“±", "ì•½": "ğŸ’Š", "ë™ì „": "ğŸª™", "ëˆˆì•Œ": "ğŸ‘ï¸", "ìˆ ": "ğŸ¥ƒ",
            "ë‹¹ì²¨ëœë³µê¶Œ": "ğŸ«", "ë¯¸ë‹ˆì—ì–´ì»¨": "â„ï¸",
            "ëª¨ë˜ì‹œê³„": "â³",
            "ì €ê²©ì´": "ğŸ¯",
            "ë„í™”ì„ ": "ğŸ”¥",
            "íŠ¸ë¦­ë°•ìŠ¤": "ğŸ"};

        const PAGE_SETTINGS = {
            // ì›¨ì´ë¸Œë³„ ì„¤ì •: [playerHP, dealerHP, liveCount, blankCount, itemCount, minBullet, maxBullet]
            1: {
                playerHP: 4, dealerHP: 5,
                live: 2, blank: 2, itemCount: 2,
                minBullet: 4, maxBullet: 6, // 4ë°œ ~ 6ë°œ ì¥ì „
                bulletText: "4ë°œ ~ 6ë°œ"
            },
            2: {
                playerHP: 5, dealerHP: 7,
                live: 3, blank: 3, itemCount: 2,
                minBullet: 5, maxBullet: 8, // 5ë°œ ~ 8ë°œ ì¥ì „
                bulletText: "5ë°œ ~ 8ë°œ"
            },
            3: {
                playerHP: 6, dealerHP: 9,
                live: 4, blank: 4, itemCount: 2,
                minBullet: 6, maxBullet: 10, // 6ë°œ ~ 10ë°œ ì¥ì „
                bulletText: "6ë°œ ~ 10ë°œ"
            },
            maxRound: 3, // ìµœëŒ€ ì›¨ì´ë¸Œ ì„¤ì •
        };

        const MAX_ITEM_SLOTS = 8; // ì•„ì´í…œ ìŠ¬ë¡¯ ê°œìˆ˜

        // --- 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        /**
         * ë°°ì—´ì˜ ìš”ì†Œë“¤ì„ ë¬´ì‘ìœ„ë¡œ ì„ìŠµë‹ˆë‹¤. (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
         */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * í…ìŠ¤íŠ¸ë¥¼ í™”ë©´ì— ì¶œë ¥í•˜ê³  ì•½ê°„ì˜ ì§€ì—°ì„ ì¤ë‹ˆë‹¤.
         */
        async function slowPrint(text, delay = 50) {
            const p = document.createElement('p');
            p.className = 'my-1';
            // ì‹¤íƒ„/ê³µí¬íƒ„ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼ë§
            p.innerHTML = text.replace(/\n/g, '<br>')
                .replace(/ì‹¤íƒ„ ğŸ”´/g, '<span class="text-red-500 font-bold">ì‹¤íƒ„ ğŸ”´</span>')
                .replace(/ê³µí¬íƒ„ ğŸŸ¡/g, '<span class="text-yellow-400 font-bold">ê³µí¬íƒ„ ğŸŸ¡</span>');
            outputElement.appendChild(p);
            outputElement.scrollTop = outputElement.scrollHeight;
            return new Promise(resolve => setTimeout(resolve, delay * 5));
        }

        // --- 4. ê²Œì„ í•µì‹¬ ë¡œì§ í•¨ìˆ˜ ---

        /**
         * ìƒˆ ì›¨ì´ë¸Œ(ë¼ìš´ë“œ)ë¥¼ ìœ„í•œ ì•„ì´í…œ ì§€ê¸‰ ë° íƒ„ì°½ ì¤€ë¹„ (ì „ì²´ ì´ˆê¸°í™”)
         * ğŸ’¡ ì›¨ì´ë¸Œ í´ë¦¬ì–´ ì‹œ í˜¸ì¶œë˜ì–´ HP, ì•„ì´í…œ, íƒ„ì°½ì„ ëª¨ë‘ ë¦¬ì…‹í•©ë‹ˆë‹¤.
         */
        function setupNewRound() {
            const round = gameState.currentPage;
            const settings = PAGE_SETTINGS[round];

            if (!settings) {
                // ì›¨ì´ë¸Œ ì„¤ì •ì´ ì—†ìœ¼ë©´ (ì˜ˆ: 4ì›¨ì´ë¸Œ) ê²Œì„ ì¢…ë£Œ ë˜ëŠ” ì •ì§€
                return;
            }

            // 1. HP ì´ˆê¸°í™” ë° ì„¤ì •
            gameState.playerHP = settings.playerHP;
            gameState.dealerHP = settings.dealerHP;

            // 1-1. íŠ¹ìˆ˜ ëŠ¥ë ¥: ìµœí›„ì˜ ë§Œì°¬ (LastSupper) íš¨ê³¼ ì ìš©
            if (gameState.selectedPerk === 'LastSupper' && gameState.currentPage === 1) {
                // ğŸ’¡ [ìˆ˜ì •] HP +1 -> HP +2ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
                gameState.playerHP += 2;
                console.log("ìµœí›„ì˜ ë§Œì°¬ (1 ì›¨ì´ë¸Œ) íš¨ê³¼ ì ìš©: í”Œë ˆì´ì–´ HP +2");
            }


            // 2. ì•„ì´í…œ ì´ˆê¸°í™” ë° ì§€ê¸‰!
            gameState.playerItems = []; // ì•„ì´í…œ ë¦¬ì…‹
            gameState.dealerItems = []; // ì•„ì´í…œ ë¦¬ì…‹
            const allItems = Object.keys(ITEM_EFFECTS);

            function giveRandomItem(itemsArray) {
                const item = shuffle([...allItems])[0];
                itemsArray.push(item);
                return item;
            }

            // ì›¨ì´ë¸Œ ì„¤ì •ì˜ itemCount ë§Œí¼ ì•„ì´í…œì„ ì§€ê¸‰ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            for (let i = 0; i < settings.itemCount; i++) {
                giveRandomItem(gameState.playerItems);
                giveRandomItem(gameState.dealerItems);
            }

            // ğŸ’¡ [ì¶”ê°€] íŠ¹ìˆ˜ ëŠ¥ë ¥: 1-2. í–‰ìš´ì˜ ì£¼ë¨¸ë‹ˆ
            if (gameState.selectedPerk === 'LuckyPouch') {
                // ì•„ì´í…œ ì§€ê¸‰ ë£¨í”„ì™€ ë³„ê°œë¡œ, í”Œë ˆì´ì–´ì—ê²Œ ì•„ì´í…œ 1ê°œ ì¶”ê°€ ì§€ê¸‰
                giveRandomItem(gameState.playerItems);
                console.log("í–‰ìš´ì˜ ì£¼ë¨¸ë‹ˆ íš¨ê³¼ ì ìš©: í”Œë ˆì´ì–´ ì•„ì´í…œ +1");
            }
            // ----------------------------------------------------


            // 3. ì„ì‹œ íš¨ê³¼ ë¦¬ì…‹ (ì›¨ì´ë¸Œê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ëª¨ë‘ ë¦¬ì…‹)
            gameState.playerProtected = false;
            gameState.dealerProtected = false;
            gameState.playerSawActive = false;
            gameState.dealerSawActive = false;
            gameState.dealerSkipNextTurn = false;
            gameState.playerSkipNextTurn = false;
            gameState.playerDamageFixToOne = false;
            gameState.dealerDamageFixToOne = false;


            // 4. ì´ ì´ì•Œ ê°œìˆ˜ ê²°ì • (ìµœì†Œ minBullet ë°œ, ìµœëŒ€ maxBullet ë°œ)
            const minBullet = settings.minBullet || 2;
            const totalBullets = Math.floor(Math.random() * (settings.maxBullet - minBullet + 1)) + minBullet;

            // 5. ì‹¤íƒ„ ê°œìˆ˜ ê²°ì • (0ê°œë¶€í„° ì´ ì´ì•Œ ê°œìˆ˜ê¹Œì§€)
            const liveCount = Math.floor(Math.random() * (totalBullets + 1));

            // 6. ê³µí¬íƒ„ ê°œìˆ˜ ê²°ì • (ì´ì•Œ - ì‹¤íƒ„)
            const blankCount = totalBullets - liveCount;

            // 7. ìƒˆ íƒ„ì°½ ìƒì„± ë° ì„ê¸°
            const newMagazine = [];
            for (let i = 0; i < liveCount; i++) newMagazine.push(true);
            for (let i = 0; i < blankCount; i++) newMagazine.push(false);

            gameState.magazine = shuffle(newMagazine);
            gameState.knownNextShot = null;

            // ğŸ’¡ [ì¶”ê°€] íŠ¹ìˆ˜ ëŠ¥ë ¥: ì¶•ë³µë°›ì€ íƒ„ì°½ (BlessedMagazine) íš¨ê³¼ ì ìš©
            if (gameState.selectedPerk === 'BlessedMagazine') {
                const blankIndex = gameState.magazine.findIndex(isLive => isLive === false);

                if (blankIndex > 0) {
                    // ê³µí¬íƒ„ì„ ì°¾ì•˜ë‹¤ë©´, ê·¸ ê³µí¬íƒ„ì„ ë§¨ ì•ìœ¼ë¡œ ì´ë™
                    const blankBullet = gameState.magazine.splice(blankIndex, 1)[0];
                    gameState.magazine.unshift(blankBullet);
                    console.log("ì¶•ë³µë°›ì€ íƒ„ì°½ íš¨ê³¼ ì ìš©: ì²« íƒ„í™˜ì€ ë¬´ì¡°ê±´ ê³µí¬íƒ„ìœ¼ë¡œ ì„¤ì •ë¨.");
                } else if (blankIndex === 0) {
                    console.log("ì¶•ë³µë°›ì€ íƒ„ì°½ íš¨ê³¼ ì ìš©: ì²« íƒ„í™˜ì´ ì´ë¯¸ ê³µí¬íƒ„ì…ë‹ˆë‹¤.");
                } else if (gameState.magazine.length > 0) {
                    // ê³µí¬íƒ„ì´ ì•„ì˜ˆ ì—†ëŠ” ìƒí™©(ëª¨ë‘ ì‹¤íƒ„)ì´ë¼ë©´, ì²« íƒ„í™˜ì„ ê°•ì œë¡œ ê³µí¬íƒ„ìœ¼ë¡œ ë³€ê²½
                    gameState.magazine[0] = false;
                    console.warn("ì¶•ë³µë°›ì€ íƒ„ì°½ ê²½ê³ : ê³µí¬íƒ„ì´ ì—†ì–´ ì²« íƒ„í™˜ì„ ê°•ì œë¡œ ê³µí¬íƒ„ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.");
                }
            }
            // ----------------------------------------------------


            // 8. ì›¨ì´ë¸Œ ì •ë³´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (UI ê°±ì‹ ì„ ìœ„í•´)
            settings.bulletText = `${totalBullets}ë°œ (ì‹¤íƒ„ ${liveCount}, ê³µí¬íƒ„ ${blankCount})`;

        }

        /**
         * íŠ¹ìˆ˜ ëŠ¥ë ¥ ì„ íƒ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showPerkSelectionModal() {
            const modal = document.getElementById('perk-modal');
            const optionsContainer = document.getElementById('perk-options');
            optionsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            // PERKS ê°ì²´ë¥¼ ìˆœíšŒí•˜ë©° ë²„íŠ¼ ìƒì„±
            Object.keys(PERKS).forEach(perkId => {
                const perk = PERKS[perkId];
                const button = document.createElement('button');

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§
                button.className = 'w-full text-left p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-200 border border-transparent hover:border-red-500';

                button.innerHTML = `
            <p class="text-xl font-bold text-white">${perk.name}</p>
            <p class="text-sm text-gray-300 mt-1">${perk.description}</p>
        `;

                // ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ í•¨ìˆ˜ í˜¸ì¶œ
                button.onclick = () => selectPerk(perkId);
                optionsContainer.appendChild(button);
            });

            modal.classList.remove('hidden'); // ëª¨ë‹¬ í‘œì‹œ
        }

        /**
         * íŠ¹ìˆ˜ ëŠ¥ë ¥ì„ ì„ íƒí•˜ê³  ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        async function selectPerk(perkId) {
            gameState.selectedPerk = perkId; // íŠ¹ìˆ˜ ëŠ¥ë ¥ ì €ì¥
            document.getElementById('perk-modal').classList.add('hidden'); // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            await slowPrint(`\n\nâœ… í”Œë ˆì´ì–´ê°€ íŠ¹ìˆ˜ ëŠ¥ë ¥ '${PERKS[perkId].name}'ì„(ë¥¼) ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
            startGame(); // ê²Œì„ ì‹œì‘! (ì´ì œ selectedPerkê°€ trueì´ë¯€ë¡œ ë°”ë¡œ ì‹œì‘ ë¡œì§ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤)
        }


        function reloadMagazine() {
            const round = gameState.currentPage;
            const settings = PAGE_SETTINGS[round];

            if (!settings) return { player: null, dealer: null };

            // 1. ì´ì•Œ ìˆ˜ ê²°ì •, ì¥ì „ ë° ì„ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const minBullet = settings.minBullet || 2;
            const totalBullets = Math.floor(Math.random() * (settings.maxBullet - minBullet + 1)) + minBullet;

            const liveCount = Math.floor(Math.random() * (totalBullets + 1));
            const blankCount = totalBullets - liveCount;
            const newMagazine = [];
            for (let i = 0; i < liveCount; i++) newMagazine.push(true);
            for (let i = 0; i < blankCount; i++) newMagazine.push(false);

            gameState.magazine = shuffle(newMagazine);
            gameState.knownNextShot = null;

            settings.bulletText = `${totalBullets}ë°œ (ì‹¤íƒ„ ${liveCount}, ê³µí¬íƒ„ ${blankCount})`;

            // 2. ì‚¬ê²© ê´€ë ¨ ì„ì‹œ íš¨ê³¼ ë¦¬ì…‹ (íƒ„ì°½ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ë¦¬ì…‹)
            gameState.playerProtected = false;
            gameState.dealerProtected = false;
            gameState.playerSawActive = false;
            gameState.dealerSawActive = false;
            gameState.playerDamageFixToOne = false;
            gameState.dealerDamageFixToOne = false;

            // 3. ì•„ì´í…œ ì¶”ê°€ ì§€ê¸‰ (ğŸ’¡ 2ê°œì”© ì§€ê¸‰í•˜ë„ë¡ ìˆ˜ì •)
            const allItems = Object.keys(ITEM_EFFECTS);
            let addedItems = { player: [], dealer: [] }; // ì•„ì´í…œ ë°°ì—´ì„ ì €ì¥í•˜ë„ë¡ ë³€ê²½

            // MAX_ITEM_SLOTS(8ê°œ) ì œí•œì„ ë‘ì–´ ì•„ì´í…œì´ ë¬´í•œì • ëŠ˜ì–´ë‚˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
            function giveRandomItem(itemsArray) {
                if (itemsArray.length < MAX_ITEM_SLOTS) {
                    const item = shuffle([...allItems])[0];
                    itemsArray.push(item);
                    return item;
                }
                return null; // ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìœ¼ë©´ null ë°˜í™˜
            }

            // ğŸ’¡ í”Œë ˆì´ì–´ì—ê²Œ 2ê°œ ì§€ê¸‰
            for (let i = 0; i < 2; i++) {
                const pItem = giveRandomItem(gameState.playerItems);
                if (pItem) addedItems.player.push(pItem);
            }
            // ğŸ’¡ ë”œëŸ¬ì—ê²Œ 2ê°œ ì§€ê¸‰
            for (let i = 0; i < 2; i++) {
                const dItem = giveRandomItem(gameState.dealerItems);
                if (dItem) addedItems.dealer.push(dItem);
            }

            // ì•„ì´í…œì„ í•˜ë‚˜ë¼ë„ ë°›ì•˜ë‹¤ë©´ ë°°ì—´ì„, ì•„ë‹ˆë©´ nullì„ ë°˜í™˜í•˜ì—¬ ë¡œê¹… ë¡œì§ì„ ì§€ì›
            return {
                player: addedItems.player.length > 0 ? addedItems.player : null,
                dealer: addedItems.dealer.length > 0 ? addedItems.dealer : null
            };
        }


        /**
         * ìŠ¹ë¦¬ ì¡°ê±´ì„ í™•ì¸í•˜ê³  ê²Œì„ì„ ì¢…ë£Œí•˜ê±°ë‚˜ ë‹¤ìŒ í„´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
         */
        async function checkWinCondition() {
            // 1. í”Œë ˆì´ì–´ íŒ¨ë°°
            if (gameState.playerHP <= 0) {
                await slowPrint(`\nğŸ’€ í”Œë ˆì´ì–´ íŒ¨ë°°! ë”œëŸ¬ê°€ ìµœì¢… ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤. ğŸ’€`);
                gameState.turn = 'end';
                renderUI();
                return true;
            }

            // 2. ë”œëŸ¬ ìŠ¹ë¦¬ (ì›¨ì´ë¸Œ í´ë¦¬ì–´)
            if (gameState.dealerHP <= 0) {
                await slowPrint(`\nğŸ‰ í”Œë ˆì´ì–´ ìŠ¹ë¦¬! ë”œëŸ¬ë¥¼ ë¬´ì°”ë €ìŠµë‹ˆë‹¤! ğŸ‰`);

                if (gameState.currentPage < PAGE_SETTINGS.maxRound) {
                    // ğŸ’¡ ë‹¤ìŒ ì›¨ì´ë¸Œë¡œ ì§„ì… (ì•„ì´í…œ ì´ˆê¸°í™” ì‹œì )
                    await slowPrint(`\n\nğŸŒŸ ì›¨ì´ë¸Œ í´ë¦¬ì–´! ${gameState.currentPage + 1} ì›¨ì´ë¸Œë¡œ ì§„ì…í•©ë‹ˆë‹¤! ğŸŒŸ`);
                    gameState.currentPage += 1; // ì›¨ì´ë¸Œ ì¦ê°€

                    setupNewRound(); // HP, ì•„ì´í…œ, íƒ„ì°½ ëª¨ë‘ ì´ˆê¸°í™”

                    gameState.turn = 'player'; // ë‹¤ìŒ ì›¨ì´ë¸ŒëŠ” í”Œë ˆì´ì–´ í„´ìœ¼ë¡œ ì‹œì‘
                    renderUI();
                    await slowPrint("\nìƒˆë¡œìš´ ì›¨ì´ë¸Œê°€ ì‹œì‘ë©ë‹ˆë‹¤. í”Œë ˆì´ì–´ì˜ í„´ì…ë‹ˆë‹¤.");
                    return true;
                } else {
                    await slowPrint(`\n\nğŸ† ëª¨ë“  ì›¨ì´ë¸Œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìµœì¢… ìŠ¹ë¦¬! ğŸ†`);
                    gameState.turn = 'end';
                    renderUI();
                    return true;
                }
            }

            // 3. íƒ„ì°½ì´ ë¹„ì—ˆê³ , HPê°€ ëª¨ë‘ ë‚¨ì•„ìˆëŠ” ê²½ìš° (ìë™ ì¬ì¥ì „ ë° ì•„ì´í…œ ì§€ê¸‰)
            if (gameState.magazine.length === 0 && gameState.turn !== 'end') {
                if (gameState.currentPage <= PAGE_SETTINGS.maxRound) {

                    // ğŸ’¡ ìë™ ë¦¬ë¡¤ ë° ì•„ì´í…œ/HP ìœ ì§€
                    const addedItems = reloadMagazine(); // <-- ì•„ì´í…œ ì§€ê¸‰ ë° íƒ„ì°½ ë¦¬ë¡œë“œ

                    await slowPrint(`\n\nğŸ”„ íƒ„ì°½ì´ ëª¨ë‘ ë¹„ì—ˆìŠµë‹ˆë‹¤! ìë™ìœ¼ë¡œ ì¬ì¥ì „ë©ë‹ˆë‹¤. ì•„ì´í…œê³¼ HPëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`);

                    // ğŸ’¡ ì•„ì´í…œ ì§€ê¸‰ ë¡œê¹… (ë°°ì—´ì„ ë°›ì•„ ì¶œë ¥í•˜ë„ë¡ ìˆ˜ì •)
                    // ë°°ì—´ì„ ', 'ë¡œ í•©ì¹˜ê³ , ì•ë’¤ì— ì‘ì€ë”°ì˜´í‘œë¥¼ ë¶™ì—¬ì„œ ê¹”ë”í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
                    const playerItemsLog = addedItems.player ? `'${addedItems.player.join("', '")}'` : null;
                    const dealerItemsLog = addedItems.dealer ? `'${addedItems.dealer.join("', '")}'` : null;

                    if (playerItemsLog || dealerItemsLog) {
                        let log = "ğŸ ë¦¬ë¡¤ ë³´ë„ˆìŠ¤: ";
                        if (playerItemsLog) {
                            log += `í”Œë ˆì´ì–´ ${playerItemsLog} íšë“`;
                        }
                        if (dealerItemsLog) {
                            if (playerItemsLog) log += ", ";
                            log += `ë”œëŸ¬ ${dealerItemsLog} íšë“`;
                        }
                        await slowPrint(log + ".");
                    }

                    renderUI();
                    // í„´ì€ ì´ë¯¸ shotgunActionì—ì„œ ê²°ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  ê²Œì„ ì§„í–‰.
                    if (gameState.turn === 'dealer') {
                        setTimeout(dealerTurn, 1500);
                    }
                } else {

                }
                return true;
            }

            return false;
        }

        /**
         * ë”œëŸ¬ì˜ í„´ ë¡œì§ (ì•„ì´í…œ ì‚¬ìš© ë° ì‚¬ê²©) - AI ë¡œì§
         */
        async function dealerTurn() {
            if (gameState.turn !== 'dealer' || await checkWinCondition()) return;

            await slowPrint("\nğŸ¤– ë”œëŸ¬ì˜ í„´ì…ë‹ˆë‹¤...");

            // ë”œëŸ¬ AI ë¡œì§: ì•„ì´í…œ ì‚¬ìš© (ìµœëŒ€ 3ê°œê¹Œì§€ ì—°ì† ì‚¬ìš© ì‹œë„)
            for (let i = 0; i < 3; i++) {
                const itemToUseIndex = findBestDealerItem();
                if (itemToUseIndex !== -1) {
                    await useDealerItemAI(itemToUseIndex);
                    // ì•„ì´í…œ ì‚¬ìš© í›„ ì ì‹œ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 500));
                } else {
                    break; // ë” ì´ìƒ ì‚¬ìš©í•  ì•„ì´í…œì´ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
                }
            }

            // ë”œëŸ¬ ì‚¬ê²© ê²°ì • (ê°„ë‹¨í™”ëœ AI)
            let target = 'dealer';

            // ì‹¤íƒ„/ê³µí¬íƒ„ ìˆ˜ ë¹„ìœ¨
            const liveCount = gameState.magazine.filter(b => b).length;
            const blankCount = gameState.magazine.filter(b => !b).length;
            const totalBullets = liveCount + blankCount;
            const liveRatio = totalBullets > 0 ? (liveCount / totalBullets) : 0;

            if (gameState.knownNextShot === true) {
                target = 'player'; // ì‹¤íƒ„ í™•ì • -> í”Œë ˆì´ì–´ì—ê²Œ ì˜ê¸°
            } else if (gameState.knownNextShot === false) {
                target = 'dealer'; // ê³µí¬íƒ„ í™•ì • -> ìì‹ ì—ê²Œ ì˜ê¸° (í„´ ìœ ì§€)
            } else {
                // ëª¨ë¥¼ ë•Œ: ì‹¤íƒ„ ë¹„ìœ¨ > 50% ì´ê³ , ë”œëŸ¬ê°€ ëœ ìœ„í—˜í•  ë•Œ ìƒëŒ€ì—ê²Œ ì ì§€ ê²°ì •
                if (liveRatio > 0.5 && gameState.dealerHP >= gameState.playerHP) {
                    target = 'player';
                } else {
                    target = 'dealer';
                }
            }

            // ì‚¬ê²© ì‹¤í–‰
            if (gameState.magazine.length > 0) {
                await shotgunAction(target);
            } else {
                // íƒ„ì°½ì´ ë¹„ì—ˆëŠ”ë°, checkWinCondition()ì´ í˜¸ì¶œë˜ì§€ ì•Šì€ ì˜ˆì™¸ ìƒí™© ë°©ì§€
                await checkWinCondition();
            }
        }

        /**
         * ë”œëŸ¬ AIê°€ ì‚¬ìš©í•  ì•„ì´í…œì„ ê²°ì •í•©ë‹ˆë‹¤. (ê°œì„ ëœ ìš°ì„ ìˆœìœ„ ì „ëµ)
         */
        function findBestDealerItem() {
            const items = gameState.dealerItems;

            // 1. [ê³µê²©] ì‹¤íƒ„ í™•ì • + ì‡ í†±/ë™ì „ (ìµœìš°ì„ )
            if (gameState.knownNextShot === true) {
                if (items.includes("ì‡ í†±") && !gameState.dealerSawActive) return items.indexOf("ì‡ í†±");
                // ğŸ’¡ [ë™ì „ ì¶”ê°€] ì‡ í†±ì´ ì—†ì§€ë§Œ ë™ì „ì´ ìˆê³ , ì•„ì§ í™œì„±í™”ë˜ì§€ ì•Šì•˜ì„ ë•Œ
                if (items.includes("ë™ì „") && !gameState.dealerDamageAddOne) return items.indexOf("ë™ì „");
            }

            // 2. [ì •ë³´] ë‹¤ìŒ íƒ„í™˜ì„ ëª¨ë¥¼ ë•Œ, í™•ëŒ€ê²½/íœ´ëŒ€í° ì‚¬ìš©
            if (gameState.knownNextShot === null) {
                if (items.includes("í™•ëŒ€ê²½")) return items.indexOf("í™•ëŒ€ê²½");
                if (items.includes("íœ´ëŒ€í°") && gameState.magazine.length > 2) return items.indexOf("íœ´ëŒ€í°");
            }
            // 3. [ë°©ì–´] HPê°€ 2 ì´í•˜ë¡œ ë‚®ê³ , ë‹´ë°°ê°€ ìˆì„ ë•Œ
            if (gameState.dealerHP <= 3 && items.includes("ë‹´ë°°")) {
                return items.indexOf("ë‹´ë°°");
            }
            if (gameState.dealerHP <= 2 && items.includes("ì•½")) {
                return items.indexOf("ì•½");
            }
            if (gameState.dealerHP <= 3 && items.includes("ìˆ ") && !gameState.dealerDrunkSkip) {
                return items.indexOf("ìˆ ");
            }
            // 4. [ë°©ì–´] ë‹¤ìŒ ì‚¬ê²©ì´ ì‹¤íƒ„ í™•ì •ì´ê³  ë°©íƒ„ë³µì´ ì—†ì„ ë•Œ
            if (gameState.knownNextShot === true && items.includes("ë°©íƒ„ë³µ") && !gameState.dealerProtected) {
                return items.indexOf("ë°©íƒ„ë³µ");
            }
            // 5. [íšŒí”¼/í„´ ìœ ì§€] ë‹¤ìŒ íƒ„í™˜ì´ ê³µí¬íƒ„ í™•ì •ì¼ ë•Œ (ì†í†±/ë§¥ì£¼ë¡œ í„´ ìœ ì§€ ê¸°íšŒ ëŠ˜ë¦¼)
            if (gameState.knownNextShot === false && gameState.magazine.length > 2) {
                if (items.includes("ì†í†±")) return items.indexOf("ì†í†±");
                if (items.includes("ë§¥ì£¼")) return items.indexOf("ë§¥ì£¼");
            }
            // 6. [ì§ì ‘ í”¼í•´] ë‚˜ì´í”„ ì‚¬ìš© (HP ì°¨ì´ê°€ í´ ë•Œ, ê³µê²©ì ìœ¼ë¡œ ì‚¬ìš©)
            if (items.includes("ë‚˜ì´í”„") && gameState.playerHP > gameState.dealerHP) {
                return items.indexOf("ë‚˜ì´í”„");
            }
            if (items.includes("ë‹¹ì²¨ëœë³µê¶Œ") && gameState.playerHP >= gameState.dealerHP) {
                return items.indexOf("ë‹¹ì²¨ëœë³µê¶Œ");
            }
            // 7. [êµë€] í”Œë ˆì´ì–´ ì•„ì´í…œì´ 3ê°œ ì´ìƒì¼ ë•Œ, ì£¼ì‚¬ê¸° ì‚¬ìš©
            if (items.includes("ì£¼ì‚¬ê¸°") && gameState.playerItems.length >= 3) {
                return items.indexOf("ì£¼ì‚¬ê¸°");
            }
            // 8. [ë¶€ì ] ë‹¤ìŒ ì‚¬ê²©ì´ ì‹¤íƒ„ì´ê±°ë‚˜ ëª¨ë¥¼ ë•Œ, HPê°€ 1ì¼ ë•Œ ë¶€ì  ì‚¬ìš©
            if (items.includes("ë¶€ì ") && gameState.dealerHP === 1 && !gameState.dealerDamageFixToOne) {
                return items.indexOf("ë¶€ì ");
            }
            // 9. [í­íƒ„] ë”œëŸ¬ì˜ HPê°€ 3 ì´ìƒì¼ ë•Œ (ë¦¬ìŠ¤í¬ê°€ ì ì„ ë•Œ)
            if (items.includes("í­íƒ„") && gameState.dealerHP >= 3) {
                return items.indexOf("í­íƒ„");
            }
            // 9. [ì •ë³´/ë³€ìˆ˜] íƒ„í™˜ ì •ë³´ê°€ í™•ì‹¤ì¹˜ ì•Šê³  íƒ„í™˜ì´ ë§ì„ ë•Œ 'ì—ì–´ì»¨' ì‚¬ìš©
            if (items.includes("ë¯¸ë‹ˆì—ì–´ì»¨") && gameState.magazine.length >= 4 && gameState.knownNextShot === null) {
                return items.indexOf("ë¯¸ë‹ˆì—ì–´ì»¨");
            }

            // 10. [ë„ë°•] ì•„ì´í…œì´ 1ê°œ ì´í•˜ë¡œ ë¶€ì¡±í•  ë•Œ 'ëˆˆì•Œ' ì‚¬ìš©
            if (items.includes("ëˆˆì•Œ") && gameState.dealerItems.length <= 1) {
                return items.indexOf("ëˆˆì•Œ");
            }

            // ğŸ’¡ [ì¶”ê°€] ì €ê²©ì´ (ê³µê²©)
            // í”Œë ˆì´ì–´ HPê°€ ë†’ì„ ë•Œ ì €ê²©í•˜ì—¬ ê²©ì°¨ë¥¼ ì¤„ì…ë‹ˆë‹¤.
            if (items.includes("ì €ê²©ì´") && gameState.playerHP > gameState.dealerHP) {
                return items.indexOf("ì €ê²©ì´");
            }

            // ğŸ’¡ [ì¶”ê°€] ëª¨ë˜ì‹œê³„ (ì •ë³´/ë¦¬ì…‹)
            const liveCount = gameState.magazine.filter(b => b).length;
            const blankCount = gameState.magazine.filter(b => !b).length;
            // íƒ„í™˜ ì •ë³´ê°€ ë¶ˆí™•ì‹¤í•˜ê³  ì‹¤íƒ„ ê°œìˆ˜ê°€ ê³µí¬íƒ„ë³´ë‹¤ 2ê°œ ì´ìƒ ë§ì„ ë•Œ ë¦¬ì…‹ ì‹œë„
            if (items.includes("ëª¨ë˜ì‹œê³„") && gameState.knownNextShot === null && liveCount > blankCount + 2) {
                return items.indexOf("ëª¨ë˜ì‹œê³„");
            }

            // ğŸ’¡ [ì¶”ê°€] ë„í™”ì„  (ë°©ì–´)
            // ë”œëŸ¬ì˜ ë„í™”ì„ ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ê³ , í”Œë ˆì´ì–´ ì•„ì´í…œì´ 3ê°œ ì´ìƒì¼ ë•Œ í­íƒ„ ëŒ€ë¹„
            if (items.includes("ë„í™”ì„ ") && !gameState.dealerFuseActive && gameState.playerItems.length >= 3) {
                return items.indexOf("ë„í™”ì„ ");
            }

            // ğŸ’¡ [ì¶”ê°€] íŠ¸ë¦­ë°•ìŠ¤ (ë„ë°•)
            // ë”œëŸ¬ HPê°€ 3 ì´í•˜ë¡œ ë‚®ê³ , í”Œë ˆì´ì–´ HPê°€ ë”œëŸ¬ë³´ë‹¤ 2 ì´ìƒ ë†’ì„ ë•Œ ì—­ì „ ê¸°íšŒ ë…¸ë¦¼
            if (items.includes("íŠ¸ë¦­ë°•ìŠ¤") && gameState.dealerHP <= 3 && gameState.playerHP > gameState.dealerHP + 2) {
                return items.indexOf("íŠ¸ë¦­ë°•ìŠ¤");
            }

            return -1;
        }


        /**
         * í”Œë ˆì´ì–´ê°€ ì•„ì´í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
         */
        async function usePlayerItem(item, index) { // ìœ ì € ì•„ì´í…œ ì‚¬ìš©
            // ì•„ì´í…œ ì‚¬ìš© ì „ ë¡œê¹…
            await slowPrint(`\n[ì•„ì´í…œ ì‚¬ìš©] ğŸ˜ í”Œë ˆì´ì–´ê°€ '${item}'ì„(ë¥¼) ì‚¬ìš©í•©ë‹ˆë‹¤.`);

            gameState.playerItems.splice(index, 1); // ì•„ì´í…œ ì‚¬ìš© í›„ ì œê±°
            const maxPlayerHP = PAGE_SETTINGS[gameState.currentPage]?.playerHP || 10;

            switch (item) {
                case "í™•ëŒ€ê²½":
                    if (gameState.magazine.length > 0) {
                        gameState.knownNextShot = gameState.magazine[0];
                        await slowPrint(`ğŸ” íš¨ê³¼: ë‹¤ìŒ íƒ„í™˜ì€ ${gameState.knownNextShot ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'} ì…ë‹ˆë‹¤.`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: íƒ„ì°½ì´ ë¹„ì–´ìˆì–´ ì •ë³´ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "íœ´ëŒ€í°":
                    if (gameState.magazine.length > 0) {
                        // ì‚¬ìš©ìì—ê²Œ í™•ì¸í•  íƒ„í™˜ ë²ˆí˜¸ ì…ë ¥ ìš”ì²­ (1ë¶€í„° ì‹œì‘)
                        const input = prompt(`ğŸ“± ëª‡ ë²ˆì§¸ íƒ„í™˜ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (1 ~ ${gameState.magazine.length})`);
                        const index = parseInt(input) - 1; // ë°°ì—´ ì¸ë±ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ -1

                        // ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
                        if (isNaN(index) || index < 0 || index >= gameState.magazine.length) {
                            await slowPrint("âŒ íš¨ê³¼: ìœ íš¨í•˜ì§€ ì•Šì€ íƒ„í™˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. (ì•„ì´í…œ ë³µêµ¬ ë¶ˆê°€)");
                            // ì•„ì´í…œì€ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ ë³µêµ¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        } else {
                            const isLive = gameState.magazine[index];
                            // ì •ë³´ë¥¼ ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. (UI ë Œë”ë§ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
                            gameState.knownBulletInfo.push({index: index, isLive: isLive});
                            await slowPrint(`ğŸ“± íš¨ê³¼: ${index + 1}ë²ˆì§¸ íƒ„í™˜ì€ ${isLive ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'} ì…ë‹ˆë‹¤.`);
                        }
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: íƒ„ì°½ì´ ë¹„ì–´ìˆì–´ ì •ë³´ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ìˆ˜ê°‘":
                    gameState.dealerSkipNextTurn = true;
                    await slowPrint("ğŸ”— íš¨ê³¼: ë”œëŸ¬ì˜ ë‹¤ìŒ í„´ì´ ìŠ¤í‚µë©ë‹ˆë‹¤.");
                    break;
                case "ë‹´ë°°":
                    const maxP_HP_Cig = PAGE_SETTINGS[gameState.currentPage]?.playerHP || 10;
                    gameState.playerHP = Math.min(gameState.playerHP + 1, maxP_HP_Cig);
                    await slowPrint(`ğŸš¬ íš¨ê³¼: HP +1 íšŒë³µ. (í˜„ì¬ HP: ${gameState.playerHP})`);
                    break;
                case "ì•½":
                    const isSuccess = Math.random() < 0.5; // 50% í™•ë¥ 
                    if (isSuccess) {
                        gameState.playerHP += 2;
                        await slowPrint(`ğŸ’Š íš¨ê³¼: HP +2 íšŒë³µ! í–‰ìš´ì˜ ì•½ì´ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${gameState.dealerHP})`);
                    } else {
                        gameState.playerHP = Math.max(0, gameState.playerHP - 1);
                        await slowPrint(`ğŸ’Š íš¨ê³¼: HP -1 í”¼í•´! ë¶ˆìš´ì˜ ì•½ì´ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${gameState.playerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "ë™ì „":
                    const coinSuccess = Math.random() < 0.7; // 70% í™•ë¥ 
                    if (coinSuccess) {
                        gameState.playerDamageAddOne = true;
                        await slowPrint("ğŸª™ íš¨ê³¼: ë‹¤ìŒ ì‚¬ê²©ì˜ í”¼í•´ê°€ +1 ì¦ê°€í•©ë‹ˆë‹¤! (70% ì„±ê³µ)");
                    } else {
                        gameState.playerHP = Math.max(0, gameState.playerHP - 1);
                        await slowPrint(`ğŸª™ íš¨ê³¼: 1 í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤. (30% ì‹¤íŒ¨) (HP: ${gameState.playerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "ëˆˆì•Œ":
                    gameState.playerHP = Math.max(0, gameState.playerHP - 1); // HP 1 ê°ì†Œ

                    const allItems = Object.keys(ITEM_EFFECTS);
                    const item1 = shuffle([...allItems])[0];
                    const item2 = shuffle([...allItems])[0];

                    gameState.playerItems.push(item1, item2); // 2ê°œ ì•„ì´í…œ íšë“

                    await slowPrint(`ğŸ‘ï¸ íš¨ê³¼: HP 1 í”¼í•´! (HP: ${gameState.playerHP}). ëŒ€ì‹  '${item1}'ì™€ '${item2}'ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                    await checkWinCondition();
                    break;
                case "ìˆ ":
                    gameState.playerHP += 2;
                    gameState.playerDrunkSkip = true;
                    await slowPrint(`ğŸ¥ƒ íš¨ê³¼: HP +2 íšŒë³µ! (HP: ${gameState.playerHP}). ë‹¤ìŒ í„´ì€ ì‰´ê²Œìš”.`);
                    await checkWinCondition();
                    break;
                case "ë‹¹ì²¨ëœë³µê¶Œ":
                    const ticketSuccess = Math.random() < 0.5; // 50% í™•ë¥ 
                    if (ticketSuccess) {
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 1); // ë”œëŸ¬ì—ê²Œ 1 í”¼í•´
                        await slowPrint(`ğŸ« íš¨ê³¼: ìƒëŒ€ë°©ì—ê²Œ 1 í”¼í•´! í–‰ìš´ì˜ ë³µê¶Œì´ì—ˆìŠµë‹ˆë‹¤. (ë”œëŸ¬ HP: ${gameState.dealerHP})`);
                    } else {
                        const allItems = Object.keys(ITEM_EFFECTS);
                        const item = shuffle([...allItems])[0];
                        gameState.playerItems.push(item); // ì•„ì´í…œ 1ê°œ íšë“
                        await slowPrint(`ğŸ« íš¨ê³¼: ì•„ì´í…œ '${item}' 1ê°œ íšë“! ë³µê¶Œ ë‹¹ì²¨ ì‹¤íŒ¨..`);
                    }
                    await checkWinCondition();
                    break;
                case "ë¯¸ë‹ˆì—ì–´ì»¨":
                    if (gameState.magazine.length > 0) {
                        gameState.magazine.reverse(); // íƒ„í™˜ ë°°ì—´ ìˆœì„œ ë’¤ì§‘ê¸°
                        gameState.knownNextShot = null; // ì •ë³´ ì´ˆê¸°í™” (íƒ„í™˜ ìˆœì„œê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ)
                        await slowPrint(`â„ï¸ íš¨ê³¼: í˜„ì¬ íƒ„ì°½ì˜ ìˆœì„œê°€ ë’¤ì§‘í˜”ìŠµë‹ˆë‹¤!`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: íƒ„ì°½ì´ ë¹„ì–´ìˆì–´ íƒ„í™˜ì„ ë’¤ì§‘ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ì‡ í†±":
                    gameState.playerSawActive = true;
                    await slowPrint("ğŸªš íš¨ê³¼: ë‹¤ìŒ ì‚¬ê²©ì˜ í”¼í•´ê°€ 2ë°°ê°€ ë©ë‹ˆë‹¤.");
                    break;
                case "ë°©íƒ„ë³µ":
                    gameState.playerProtected = true;
                    await slowPrint("ğŸ›¡ï¸ íš¨ê³¼: ë‹¤ìŒ 1íšŒ í”¼í•´ë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤.");
                    break;
                case "ë‚˜ì´í”„":
                    gameState.dealerHP = Math.max(0, gameState.dealerHP - 1);
                    await slowPrint(`ğŸ”ª íš¨ê³¼: ë”œëŸ¬ì—ê²Œ 1 í”¼í•´! (HP: ${gameState.dealerHP})`);
                    await checkWinCondition();
                    break;
                case "ì†í†±":
                    if (gameState.magazine.length > 0) {
                        const removedBullet = gameState.magazine.shift();
                        gameState.knownNextShot = null;
                        await slowPrint(`ğŸ’… íš¨ê³¼: ë§¨ ì•ì˜ íƒ„í™˜ ${removedBullet ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'}ì„(ë¥¼) ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: íƒ„ì°½ì´ ë¹„ì–´ìˆì–´ ë°°ì¶œí•  íƒ„í™˜ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ë§¥ì£¼":
                    if (gameState.magazine.length > 0) {
                        const removedBullet = gameState.magazine.pop();
                        gameState.knownNextShot = null;
                        await slowPrint(`ğŸº íš¨ê³¼: ë§¨ ë’¤ì˜ íƒ„í™˜ ${removedBullet ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'}ì„(ë¥¼) ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: íƒ„ì°½ì´ ë¹„ì–´ìˆì–´ ë°°ì¶œí•  íƒ„í™˜ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ì£¼ì‚¬ê¸°":
                    if (gameState.dealerItems.length > 0) {
                        const stolenIndex = Math.floor(Math.random() * gameState.dealerItems.length);
                        const stolenItem = gameState.dealerItems.splice(stolenIndex, 1)[0];
                        gameState.playerItems.push(stolenItem);
                        await slowPrint(`ğŸ’‰ íš¨ê³¼: ë”œëŸ¬ì˜ '${stolenItem}'ì„ í›”ì³¤ìŠµë‹ˆë‹¤!`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: ë”œëŸ¬ê°€ ê°€ì§„ ì•„ì´í…œì´ ì—†ì–´ í›”ì¹˜ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ë¶€ì ":
                    gameState.playerDamageFixToOne = true;
                    await slowPrint("âœ¨ íš¨ê³¼: ë‹¤ìŒ 1íšŒ ì‚¬ê²©ì—ì„œ ë°›ëŠ” í”¼í•´ë¥¼ 1ë¡œ ê³ ì •í•©ë‹ˆë‹¤.");
                    break;
                case "í­íƒ„":
                    if (gameState.dealerFuseActive) {
                        await slowPrint(`ğŸ’¥ğŸ’£ ë”œëŸ¬ì˜ ë„í™”ì„ (ğŸ”¥) íš¨ê³¼ë¡œ ì¸í•´ í”Œë ˆì´ì–´ì˜ í­íƒ„ì´ ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        gameState.dealerFuseActive = false; // ë„í™”ì„  íš¨ê³¼ ì†Œëª¨
                    } else {
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 2); // ìƒëŒ€ 2 í”¼í•´
                        gameState.playerHP = Math.max(0, gameState.playerHP - 1); // ìì‹  1 í”¼í•´
                        await slowPrint(`ğŸ’¥ íš¨ê³¼: ë”œëŸ¬ì—ê²Œ 2 í”¼í•´! (HP: ${gameState.dealerHP}), ìì‹ ì—ê²Œ 1 í”¼í•´! (HP: ${gameState.playerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "ëª¨ë˜ì‹œê³„":
                    const oldMagazineLength = gameState.magazine.length;
                    const addedItems = reloadMagazine(); // íƒ„ì°½ ë¦¬ë¡œë“œ ë° ì•„ì´í…œ 2ê°œ ì§€ê¸‰
                    await slowPrint(`â³ íš¨ê³¼: ë‚¨ì•„ìˆë˜ ${oldMagazineLength}ê°œì˜ íƒ„í™˜ì„ ë²„ë¦¬ê³  ìƒˆ íƒ„ì°½ìœ¼ë¡œ ì¥ì „í–ˆìŠµë‹ˆë‹¤.`);

                    // ì¬ì¥ì „ ë³´ë„ˆìŠ¤ ì•„ì´í…œ íšë“ ë¡œê¹… (UIì— í‘œì‹œ)
                    const playerItemsLog = addedItems.player ? `'${addedItems.player.join("', '")}'` : null;
                    const dealerItemsLog = addedItems.dealer ? `'${addedItems.dealer.join("', '")}'` : null;
                    if (playerItemsLog || dealerItemsLog) {
                        let log = "ğŸ ì¬ì¥ì „ ë³´ë„ˆìŠ¤: ";
                        if (playerItemsLog) log += `í”Œë ˆì´ì–´ ${playerItemsLog} íšë“`;
                        if (dealerItemsLog) {
                            if (playerItemsLog) log += ", ";
                            log += `ë”œëŸ¬ ${dealerItemsLog} íšë“`;
                        }
                        await slowPrint(log + ".");
                    }
                    break;
                // ğŸ’¡ [ì¶”ê°€] ì €ê²©ì´
                case "ì €ê²©ì´":
                    gameState.dealerHP = Math.max(0, gameState.dealerHP - 2);
                    await slowPrint(`ğŸ¯ íš¨ê³¼: ë”œëŸ¬ì—ê²Œ 2 í”¼í•´! (HP: ${gameState.dealerHP})`);
                    await checkWinCondition();
                    break;
                // ğŸ’¡ [ì¶”ê°€] ë„í™”ì„ 
                case "ë„í™”ì„ ":
                    gameState.playerFuseActive = true;
                    await slowPrint("ğŸ”¥ íš¨ê³¼: ìƒëŒ€ë°©ì˜ ë‹¤ìŒ 'í­íƒ„' ì•„ì´í…œ ì‚¬ìš©ì„ ë¬´íš¨í™”í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    break;
                // ğŸ’¡ [ì¶”ê°€] íŠ¸ë¦­ë°•ìŠ¤
                case "íŠ¸ë¦­ë°•ìŠ¤":
                    const swapChance = Math.random() < 0.3; // 30% í™•ë¥ 
                    if (swapChance) {
                        [gameState.playerHP, gameState.dealerHP] = [gameState.dealerHP, gameState.playerHP];
                        await slowPrint(`ğŸ íš¨ê³¼: ì²´ë ¥ ë’¤ë°”ê¾¸ê¸° ì„±ê³µ! (í”Œë ˆì´ì–´ HP: ${gameState.playerHP}, ë”œëŸ¬ HP: ${gameState.dealerHP})`);
                    } else {
                        gameState.playerHP = Math.max(0, gameState.playerHP - 2);
                        await slowPrint(`ğŸ íš¨ê³¼: ì²´ë ¥ ë’¤ë°”ê¾¸ê¸° ì‹¤íŒ¨... HP -2 í”¼í•´! (HP: ${gameState.playerHP})`);
                    }
                    await checkWinCondition();
                    break;
                default:
            }

            // ì•„ì´í…œ ì‚¬ìš© í›„ UI ì—…ë°ì´íŠ¸
            renderUI();
            checkWinCondition(); // ì•„ì´í…œ ì‚¬ìš© í›„ íƒ„ì°½ì´ ë¹„ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬
        }

        /**
         * ë”œëŸ¬ê°€ ì•„ì´í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
         */
        async function useDealerItemAI(index) {
            const item = gameState.dealerItems[index];
            gameState.dealerItems.splice(index, 1);
            const maxDealerHp = PAGE_SETTINGS[gameState.currentPage]?.dealerHP || 10;
            await slowPrint(`\n[ì•„ì´í…œ ì‚¬ìš©] ğŸ¤– ë”œëŸ¬ê°€ '${item}'ì„(ë¥¼) ì‚¬ìš©í•©ë‹ˆë‹¤.`);

            switch (item) {
                case "í™•ëŒ€ê²½":
                    if (gameState.magazine.length > 0) {
                        gameState.knownNextShot = gameState.magazine[0];
                        await slowPrint(`ğŸ” íš¨ê³¼: ë‹¤ìŒ íƒ„í™˜ì€ ${gameState.knownNextShot ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'} ì…ë‹ˆë‹¤.`);
                    }
                    break;
                case "ì•½":
                    const isSuccess = Math.random() < 0.5; // 50% í™•ë¥ 
                    if (isSuccess) {
                        gameState.dealerHP += 2; // âœ… ìˆ˜ì •: HP 2 íšŒë³µ (ìµœëŒ€ì¹˜ ì´ˆê³¼ í—ˆìš©)
                        await slowPrint(`ğŸ’Š íš¨ê³¼: HP +2 íšŒë³µ! í–‰ìš´ì˜ ì•½ì´ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${gameState.playerHP})`);
                    } else {
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 1);
                        await slowPrint(`ğŸ’Š íš¨ê³¼: HP -1 í”¼í•´! ë¶ˆìš´ì˜ ì•½ì´ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${gameState.dealerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "íœ´ëŒ€í°":
                    if (gameState.magazine.length > 0) {
                        // ë”œëŸ¬ëŠ” ë¬´ì‘ìœ„ë¡œ í•˜ë‚˜ í™•ì¸í•˜ê±°ë‚˜, íƒ„í™˜ ìˆ˜ê°€ ì ì„ ë•Œ ì²˜ìŒ/ë í™•ì¸
                        const index = gameState.magazine.length <= 3 ? 0 : Math.floor(Math.random() * gameState.magazine.length);
                        const isLive = gameState.magazine[index];
                        gameState.knownBulletInfo.push({index: index, isLive: isLive});
                        await slowPrint(`ğŸ“± íš¨ê³¼: ${index + 1}ë²ˆì§¸ íƒ„í™˜ì€ ${isLive ? 'í”Œë ˆì´ì–´ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'í”Œë ˆì´ì–´ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}`);
                    }
                    break;
                case "ë™ì „":
                    const coinSuccess = Math.random() < 0.7; // 70% í™•ë¥ 
                    if (coinSuccess) {
                        gameState.dealerDamageAddOne = true;
                        await slowPrint("ğŸª™ íš¨ê³¼: ë‹¤ìŒ ì‚¬ê²©ì˜ í”¼í•´ê°€ +1 ì¦ê°€í•©ë‹ˆë‹¤! (70% ì„±ê³µ)");
                    } else {
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 1);
                        await slowPrint(`ğŸª™ íš¨ê³¼: 1 í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤. (30% ì‹¤íŒ¨) (HP: ${gameState.dealerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "ëˆˆì•Œ":
                    gameState.dealerHP = Math.max(0, gameState.dealerHP - 1); // HP 1 ê°ì†Œ

                    const allItems = Object.keys(ITEM_EFFECTS);
                    const item1 = shuffle([...allItems])[0];
                    const item2 = shuffle([...allItems])[0];

                    gameState.dealerItems.push(item1, item2); // 2ê°œ ì•„ì´í…œ íšë“

                    await slowPrint(`ğŸ‘ï¸ íš¨ê³¼: ë”œëŸ¬ HP 1 í”¼í•´! (HP: ${gameState.dealerHP}). ëŒ€ì‹  '${item1}'ì™€ '${item2}'ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                    await checkWinCondition();
                    break;
                case "ìˆ ":
                    gameState.dealerHP += 2; // âœ… ìˆ˜ì •: HP 2 íšŒë³µ (ìµœëŒ€ì¹˜ ì´ˆê³¼ í—ˆìš©)
                    gameState.dealerDrunkSkip = true;
                    await slowPrint(`ğŸ¥ƒ íš¨ê³¼: HP +2 íšŒë³µ! (HP: ${gameState.dealerHP}). ë‹¤ìŒ í„´ì€ ë”œëŸ¬ê°€ ì‰½ë‹ˆë‹¤.`);
                    await checkWinCondition();
                    break;
                case "ë‹¹ì²¨ëœë³µê¶Œ":
                    const ticketSuccess = Math.random() < 0.5; // 50% í™•ë¥ 
                    if (ticketSuccess) {
                        gameState.playerHP = Math.max(0, gameState.playerHP - 1); // í”Œë ˆì´ì–´ì—ê²Œ 1 í”¼í•´
                        await slowPrint(`ğŸ« íš¨ê³¼: í”Œë ˆì´ì–´ì—ê²Œ 1 í”¼í•´! í–‰ìš´ì˜ ë³µê¶Œì´ì—ˆìŠµë‹ˆë‹¤. (í”Œë ˆì´ì–´ HP: ${gameState.playerHP})`);
                    } else {
                        const allItems = Object.keys(ITEM_EFFECTS);
                        const item = shuffle([...allItems])[0];
                        gameState.dealerItems.push(item); // ì•„ì´í…œ 1ê°œ íšë“
                        await slowPrint(`ğŸ« íš¨ê³¼: ì•„ì´í…œ '${item}' 1ê°œ íšë“! ë³µê¶Œ ë‹¹ì²¨ ì‹¤íŒ¨..`);
                    }
                    await checkWinCondition();
                    break;
                case "ë¯¸ë‹ˆì—ì–´ì»¨":
                    if (gameState.magazine.length > 0) {
                        gameState.magazine.reverse(); // íƒ„í™˜ ë°°ì—´ ìˆœì„œ ë’¤ì§‘ê¸°
                        gameState.knownNextShot = null; // ì •ë³´ ì´ˆê¸°í™”
                        await slowPrint(`â„ï¸ íš¨ê³¼: í˜„ì¬ íƒ„ì°½ì˜ ìˆœì„œê°€ ë’¤ì§‘í˜”ìŠµë‹ˆë‹¤!`);
                    } else {
                        // ë”œëŸ¬ëŠ” ì´ ì•„ì´í…œì„ íƒ„ì°½ì´ ë¹„ì—ˆì„ ë•Œ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ AIì—ì„œ ì²˜ë¦¬
                    }
                    break;
                case "ìˆ˜ê°‘":
                    gameState.playerSkipNextTurn = true;
                    await slowPrint("ğŸ”— íš¨ê³¼: í”Œë ˆì´ì–´ì˜ ë‹¤ìŒ í„´ì´ ìŠ¤í‚µë©ë‹ˆë‹¤.");
                    break;
                case "ë‹´ë°°":
                    gameState.dealerHP = Math.min(gameState.dealerHP + 1, maxHP);
                    await slowPrint(`ğŸš¬ íš¨ê³¼: HP +1 íšŒë³µ. (í˜„ì¬ HP: ${gameState.dealerHP})`);
                    break;
                case "ì‡ í†±":
                    gameState.dealerSawActive = true;
                    await slowPrint("ğŸªš íš¨ê³¼: ë‹¤ìŒ ì‚¬ê²©ì˜ í”¼í•´ê°€ 2ë°°ê°€ ë©ë‹ˆë‹¤.");
                    break;
                case "ë°©íƒ„ë³µ":
                    gameState.dealerProtected = true;
                    await slowPrint("ğŸ›¡ï¸ íš¨ê³¼: ë‹¤ìŒ 1íšŒ í”¼í•´ë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤.");
                    break;
                case "ì£¼ì‚¬ê¸°":
                    if (gameState.playerItems.length > 0) {
                        const stolenIndex = Math.floor(Math.random() * gameState.playerItems.length);
                        const stolenItem = gameState.playerItems.splice(stolenIndex, 1)[0];
                        gameState.dealerItems.push(stolenItem);
                        await slowPrint(`ğŸ’‰ íš¨ê³¼: í”Œë ˆì´ì–´ì˜ '${stolenItem}'ì„ í›”ì³¤ìŠµë‹ˆë‹¤!`);
                    } else {
                        await slowPrint("âŒ íš¨ê³¼: í”Œë ˆì´ì–´ê°€ ê°€ì§„ ì•„ì´í…œì´ ì—†ì–´ í›”ì¹˜ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "ë‚˜ì´í”„":
                    gameState.playerHP = Math.max(0, gameState.playerHP - 1);
                    await slowPrint(`ğŸ”ª íš¨ê³¼: í”Œë ˆì´ì–´ì—ê²Œ 1 í”¼í•´! (HP: ${gameState.playerHP})`);
                    await checkWinCondition();
                    break;
                case "ì†í†±":
                    if (gameState.magazine.length > 0) {
                        const removedBullet = gameState.magazine.shift();
                        gameState.knownNextShot = null;
                        await slowPrint(`ğŸ’… íš¨ê³¼: ë§¨ ì•ì˜ íƒ„í™˜ ${removedBullet ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'}ì„(ë¥¼) ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.`);
                    }
                    break;
                case "ë§¥ì£¼":
                    if (gameState.magazine.length > 0) {
                        const removedBullet = gameState.magazine.pop();
                        gameState.knownNextShot = null;
                        await slowPrint(`ğŸº íš¨ê³¼: ë§¨ ë’¤ì˜ íƒ„í™˜ ${removedBullet ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡'}ì„(ë¥¼) ë°°ì¶œí–ˆìŠµë‹ˆë‹¤.`);
                    }
                    break;
                case "ë¶€ì ":
                    gameState.dealerDamageFixToOne = true;
                    await slowPrint("âœ¨ íš¨ê³¼: ë‹¤ìŒ 1íšŒ ì‚¬ê²©ì—ì„œ ë°›ëŠ” í”¼í•´ë¥¼ 1ë¡œ ê³ ì •í•©ë‹ˆë‹¤.");
                    break;
                case "í­íƒ„":
                    // ğŸ’¡ [ìˆ˜ì •] í”Œë ˆì´ì–´ì˜ ë„í™”ì„  íš¨ê³¼ í™•ì¸
                    if (gameState.playerFuseActive) {
                        await slowPrint(`ğŸ’¥ğŸ’£ í”Œë ˆì´ì–´ì˜ ë„í™”ì„ (ğŸ”¥) íš¨ê³¼ë¡œ ì¸í•´ ë”œëŸ¬ì˜ í­íƒ„ì´ ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        gameState.playerFuseActive = false; // ë„í™”ì„  íš¨ê³¼ ì†Œëª¨
                    } else {
                        gameState.playerHP = Math.max(0, gameState.playerHP - 2); // ìƒëŒ€(í”Œë ˆì´ì–´) 2 í”¼í•´
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 1); // ìì‹ (ë”œëŸ¬) 1 í”¼í•´
                        await slowPrint(`ğŸ’¥ íš¨ê³¼: í”Œë ˆì´ì–´ì—ê²Œ 2 í”¼í•´! (HP: ${gameState.playerHP}), ìì‹ ì—ê²Œ 1 í”¼í•´! (HP: ${gameState.dealerHP})`);
                    }
                    await checkWinCondition();
                    break;
                case "ëª¨ë˜ì‹œê³„":
                    const oldMagazineLength = gameState.magazine.length;
                    reloadMagazine(); // íƒ„ì°½ ë¦¬ë¡œë“œ ë° ì•„ì´í…œ 2ê°œ ì§€ê¸‰ (ë”œëŸ¬ëŠ” ë¡œê¹…ë§Œ í•¨)
                    await slowPrint(`â³ íš¨ê³¼: ë‚¨ì•„ìˆë˜ ${oldMagazineLength}ê°œì˜ íƒ„í™˜ì„ ë²„ë¦¬ê³  ìƒˆ íƒ„ì°½ìœ¼ë¡œ ì¥ì „í–ˆìŠµë‹ˆë‹¤.`);
                    renderUI();
                    break;
                // ğŸ’¡ [ì¶”ê°€] ì €ê²©ì´
                case "ì €ê²©ì´":
                    gameState.playerHP = Math.max(0, gameState.playerHP - 2);
                    await slowPrint(`ğŸ¯ íš¨ê³¼: í”Œë ˆì´ì–´ì—ê²Œ 2 í”¼í•´! (HP: ${gameState.playerHP})`);
                    await checkWinCondition();
                    break;
                // ğŸ’¡ [ì¶”ê°€] ë„í™”ì„ 
                case "ë„í™”ì„ ":
                    gameState.dealerFuseActive = true;
                    await slowPrint("ğŸ”¥ íš¨ê³¼: í”Œë ˆì´ì–´ì˜ ë‹¤ìŒ 'í­íƒ„' ì•„ì´í…œ ì‚¬ìš©ì„ ë¬´íš¨í™”í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    break;
                // ğŸ’¡ [ì¶”ê°€] íŠ¸ë¦­ë°•ìŠ¤
                case "íŠ¸ë¦­ë°•ìŠ¤":
                    const swapChance = Math.random() < 0.3; // 30% í™•ë¥ 
                    if (swapChance) {
                        [gameState.playerHP, gameState.dealerHP] = [gameState.dealerHP, gameState.playerHP];
                        await slowPrint(`ğŸ íš¨ê³¼: ì²´ë ¥ ë’¤ë°”ê¾¸ê¸° ì„±ê³µ! (í”Œë ˆì´ì–´ HP: ${gameState.playerHP}, ë”œëŸ¬ HP: ${gameState.dealerHP})`);
                    } else {
                        gameState.dealerHP = Math.max(0, gameState.dealerHP - 2);
                        await slowPrint(`ğŸ íš¨ê³¼: ì²´ë ¥ ë’¤ë°”ê¾¸ê¸° ì‹¤íŒ¨... HP -2 í”¼í•´! (HP: ${gameState.dealerHP})`);
                    }
                    await checkWinCondition();
                    break;
            }
            renderUI();
        }

        /**
         * ì‚¬ê²©ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
         */
        async function shotgunAction(target) {
            if (gameState.turn !== 'player' && gameState.turn !== 'dealer') return;
            if (gameState.magazine.length === 0) {
                // íƒ„ì°½ì´ ë¹„ì—ˆìœ¼ë¯€ë¡œ ì¬ì¥ì „ ì²´í¬ (ìë™ ì²˜ë¦¬ë¨)
                await checkWinCondition();
                return;
            }

            const isPlayerTurn = gameState.turn === 'player';
            const isLive = gameState.magazine.shift();

            gameState.knownNextShot = null;
            let damage = 1;
            if (gameState.playerSawActive || gameState.dealerSawActive) damage *= 2; // ì‡ í†±ì€ 2ë°°
            if (isPlayerTurn && gameState.playerDamageAddOne) damage += 1; // í”Œë ˆì´ì–´ ë™ì „ì€ +1
            if (!isPlayerTurn && gameState.dealerDamageAddOne) damage += 1; // ë”œëŸ¬ ë™ì „ì€ +1

            // 1. Log message fix (Requirement 1)
            const shooterName = isPlayerTurn ? 'í”Œë ˆì´ì–´ ğŸ˜' : 'ë”œëŸ¬ ğŸ¤–';
            let logTarget;
            if (isPlayerTurn) {
                // Player's turn: target is 'self' (player) or 'player' (dealer)
                logTarget = (target === 'self') ? 'ìì‹ ì—ê²Œ' : 'ë”œëŸ¬ì—ê²Œ';
            } else {
                // Dealer's turn: target is 'dealer' (dealer) or 'player' (player)
                logTarget = (target === 'dealer') ? 'ìì‹ ì—ê²Œ' : 'í”Œë ˆì´ì–´ì—ê²Œ';
            }
            await slowPrint(`\nğŸ”« ${shooterName}ê°€ ${logTarget} ì‚¬ê²©í–ˆìŠµë‹ˆë‹¤!`);


            // 2. í„´ ì „í™˜ ê²°ì • ì´ˆê¸°ê°’ì€ ìƒëŒ€ë°©ì—ê²Œ í„´ ë„˜ê¹€ìœ¼ë¡œ ì„¤ì •
            let nextTurn = isPlayerTurn ? 'dealer' : 'player';

            // ğŸ’¡ isShotSelf ì •ì˜: ì‚¬ê²© ëŒ€ìƒì´ ì˜ëŠ” ì‚¬ëŒ ìì‹ ì¸ì§€ í™•ì¸
            let isShotSelf;
            if (isPlayerTurn) {
                isShotSelf = target === 'self'; // í”Œë ˆì´ì–´ê°€ ìì‹ ì—ê²Œ ì˜ëŠ” ê²½ìš°
            } else {
                isShotSelf = target === 'dealer'; // ë”œëŸ¬ê°€ ìì‹ ì—ê²Œ ì˜ëŠ” ê²½ìš°
            }


            if (isLive) {
                await slowPrint("ğŸ”´ ì‹¤íƒ„ì´ì—ˆìŠµë‹ˆë‹¤!");

                let isProtected = false;
                let targetHPName = '';
                // ë§ì€ ì‚¬ëŒì´ í”Œë ˆì´ì–´ì¸ê°€?
                // í”Œë ˆì´ì–´ í„´ì´ë©´ì„œ ë”œëŸ¬ë¥¼ ì˜ê±°ë‚˜ (target='player')
                // ë”œëŸ¬ í„´ì´ë©´ì„œ í”Œë ˆì´ì–´ë¥¼ ì˜ëŠ” ê²½ìš° (target='player')
                let isPlayerTarget = (target === 'player');

                // ë”œëŸ¬ê°€ ë”œëŸ¬ì—ê²Œ ìˆì„ ë•Œ (isPlayerTurn=false, target='dealer')ëŠ” ë”œëŸ¬ê°€ íƒ€ê²Ÿì„ (isPlayerTarget=false)

                if (isPlayerTarget) {
                    isProtected = gameState.playerProtected;
                    targetHPName = 'í”Œë ˆì´ì–´';
                    // ğŸ’¡ ë¶€ì  íš¨ê³¼ ì ìš©
                    if (gameState.playerDamageFixToOne) {
                        damage = Math.min(damage, 1);
                        gameState.playerDamageFixToOne = false;
                        await slowPrint(`âœ¨ ${targetHPName}ì˜ ë¶€ì  íš¨ê³¼ë¡œ í”¼í•´ê°€ 1ë¡œ ê³ ì •ë©ë‹ˆë‹¤!`);
                    }
                } else {
                    isProtected = gameState.dealerProtected;
                    targetHPName = 'ë”œëŸ¬';
                    // ğŸ’¡ ë¶€ì  íš¨ê³¼ ì ìš©
                    if (gameState.dealerDamageFixToOne) {
                        damage = Math.min(damage, 1);
                        gameState.dealerDamageFixToOne = false;
                        await slowPrint(`âœ¨ ${targetHPName}ì˜ ë¶€ì  íš¨ê³¼ë¡œ í”¼í•´ê°€ 1ë¡œ ê³ ì •ë©ë‹ˆë‹¤!`);
                    }
                }

                if (isProtected) {
                    await slowPrint(`ğŸ›¡ï¸ ${targetHPName}ê°€ ë°©íƒ„ë³µìœ¼ë¡œ í”¼í•´ë¥¼ ë§‰ì•˜ìŠµë‹ˆë‹¤!`);
                    if (isPlayerTarget) gameState.playerProtected = false;
                    else gameState.dealerProtected = false;
                    damage = 0;
                }

                if (damage > 0) {
                    if (isPlayerTarget) {
                        gameState.playerHP -= damage;
                    } else {
                        gameState.dealerHP -= damage;
                    }
                    const targetHPVar = isPlayerTarget ? gameState.playerHP : gameState.dealerHP;
                    await slowPrint(`ğŸ’¥ ${targetHPName}ê°€ ${damage} í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤! (ë‚¨ì€ HP: ${Math.max(0, targetHPVar)})`);
                }

                // ì‡ í†± íš¨ê³¼ ì´ˆê¸°í™”
                gameState.playerSawActive = false;
                gameState.dealerSawActive = false;
                gameState.playerDamageAddOne = false;
                gameState.dealerDamageAddOne = false;

                // ğŸ’¡ ê·œì¹™: ì‹¤íƒ„ì„ ì‚¬ìš©í•˜ë©´ ì ì¤‘ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ë¬´ì¡°ê±´ ìƒëŒ€ë°©ì—ê²Œ í„´ì´ ë„˜ì–´ê°„ë‹¤.
                // nextTurnì€ ì´ë¯¸ ìƒëŒ€ë°©ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ìˆ˜ì • ë¶ˆí•„ìš”
                nextTurn = isPlayerTurn ? 'dealer' : 'player';

            } else {
                await slowPrint("ğŸŸ¡ ê³µí¬íƒ„ì´ì—ˆìŠµë‹ˆë‹¤! ğŸ’¨");
                gameState.playerDamageAddOne = false;
                gameState.dealerDamageAddOne = false;

                // ğŸ’¡ ê·œì¹™: ê³µí¬íƒ„ ì‹œ, ìì‹ ì—ê²Œ ì˜ë©´ í„´ ìœ ì§€, ìƒëŒ€ì—ê²Œ ì˜ë©´ í„´ ì „í™˜
                if (isShotSelf) {
                    // ìì‹ ì—ê²Œ ìˆì„ ë•Œ í„´ ìœ ì§€
                    nextTurn = gameState.turn;
                } else {
                    // ìƒëŒ€ì—ê²Œ ìˆì„ ë•Œ í„´ ì „í™˜
                    nextTurn = isPlayerTurn ? 'dealer' : 'player';
                }
            }

            // ğŸ’¡ ë¶€ì  íš¨ê³¼ëŠ” ì‚¬ê²© í›„ ë¦¬ì…‹ (ì‹¤íƒ„/ê³µí¬íƒ„ ë¬´ê´€)
            gameState.playerDamageFixToOne = false;
            gameState.dealerDamageFixToOne = false;


            // í„´ ì „í™˜ ì§ì „, ìˆ˜ê°‘ íš¨ê³¼ ì²˜ë¦¬ (ì´ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤)
            if (gameState.dealerSkipNextTurn && nextTurn === 'dealer') {
                await slowPrint("ğŸ”— ë”œëŸ¬ê°€ ìˆ˜ê°‘ì— ë¬¶ì—¬ í„´ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤. í”Œë ˆì´ì–´ì˜ í„´ì´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.");
                gameState.dealerSkipNextTurn = false;
                nextTurn = 'player';
            } else if (gameState.playerSkipNextTurn && nextTurn === 'player') {
                await slowPrint("ğŸ”— í”Œë ˆì´ì–´ê°€ ìˆ˜ê°‘ì— ë¬¶ì—¬ í„´ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤. ë”œëŸ¬ì˜ í„´ì´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.");
                gameState.playerSkipNextTurn = false;
                nextTurn = 'dealer';
            }

            if (gameState.playerDrunkSkip && nextTurn === 'player') {
                await slowPrint("ğŸ¥ƒ í”Œë ˆì´ì–´ê°€ ìˆ ì— ì·¨í•´ í„´ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤. ë”œëŸ¬ì˜ í„´ì´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.");
                gameState.playerDrunkSkip = false;
                nextTurn = 'dealer';
            }

            if (gameState.dealerDrunkSkip && nextTurn === 'dealer') {
                await slowPrint("ğŸ¥ƒ ë”œëŸ¬ê°€ ìˆ ì— ì·¨í•´ í„´ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤. í”Œë ˆì´ì–´ì˜ í„´ì´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.");
                gameState.dealerDrunkSkip = false;
                nextTurn = 'player';
            }

            gameState.turn = nextTurn;

            gameState.totalTurns++; // ì´ í„´ ìˆ˜ ì¦ê°€
            await slowPrint(`(ì´ ${gameState.totalTurns}í„´ ê²½ê³¼)`); // í„´ ìˆ˜ ë¡œê¹…

            if (gameState.totalTurns % 15 === 0) {
                await slowPrint("\nğŸŒŸ 15í„´ ë³´ë„ˆìŠ¤! ğŸŒŸ í”Œë ˆì´ì–´ì™€ ë”œëŸ¬ê°€ ë¬´ì‘ìœ„ ì•„ì´í…œì„ 2ê°œì”© íšë“í•©ë‹ˆë‹¤.");
                const allItems = Object.keys(ITEM_EFFECTS);

                // ì•„ì´í…œ ì§€ê¸‰ ë° ë¡œê¹…
                let addedItems = { player: [], dealer: [] };
                function giveRandomItem(itemsArray) {
                    if (itemsArray.length < MAX_ITEM_SLOTS) {
                        const item = shuffle([...allItems])[0];
                        itemsArray.push(item);
                        return item;
                    }
                    return null;
                }

                // í”Œë ˆì´ì–´ 2ê°œ ì§€ê¸‰
                for (let i = 0; i < 2; i++) {
                    const pItem = giveRandomItem(gameState.playerItems);
                    if (pItem) addedItems.player.push(pItem);
                }
                // ë”œëŸ¬ 2ê°œ ì§€ê¸‰
                for (let i = 0; i < 2; i++) {
                    const dItem = giveRandomItem(gameState.dealerItems);
                    if (dItem) addedItems.dealer.push(dItem);
                }

                const playerItemsLog = addedItems.player.length > 0 ? `'${addedItems.player.join("', '")}'` : null;
                const dealerItemsLog = addedItems.dealer.length > 0 ? `'${addedItems.dealer.join("', '")}'` : null;

                if (playerItemsLog || dealerItemsLog) {
                    let log = "ğŸ 15í„´ ë³´ë„ˆìŠ¤: ";
                    if (playerItemsLog) log += `í”Œë ˆì´ì–´ ${playerItemsLog} íšë“`;
                    if (dealerItemsLog) {
                        if (playerItemsLog) log += ", ";
                        log += `ë”œëŸ¬ ${dealerItemsLog} íšë“`;
                    }
                    await slowPrint(log + ".");
                }
            }

            renderUI();

            if (!await checkWinCondition()) {
                if (gameState.turn === 'dealer') {
                    setTimeout(dealerTurn, 1500); // ë”œëŸ¬ í„´ì€ 1.5ì´ˆ í›„ ì‹œì‘
                } else if (gameState.turn === 'player' && gameState.magazine.length === 0) {
                    await checkWinCondition();
                }
            }
        }


        // --- 5. UI ë Œë”ë§ í•¨ìˆ˜ ---
        function renderUI() {
            // 1. HP ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('dealer-hp').textContent = gameState.dealerHP;
            document.getElementById('player-hp').textContent = gameState.playerHP;
            document.getElementById('current-round').textContent = `ì›¨ì´ë¸Œ: ${gameState.currentPage} / ${PAGE_SETTINGS.maxRound}`;

            document.getElementById('current-turn').innerHTML = `í„´: <span class="${gameState.turn === 'player' ? 'text-green-400' : 'text-red-400'}">${gameState.turn === 'player' ? 'í”Œë ˆì´ì–´ ğŸ˜' : (gameState.turn === 'dealer' ? 'ë”œëŸ¬ ğŸ¤–' : 'ê²Œì„ ì¢…ë£Œ')}</span>`;
            document.getElementById('magazine-status').textContent = `íƒ„ì°½: ${gameState.magazine.length} ë°œ (ì‹¤íƒ„: ${gameState.magazine.filter(b => b).length}, ê³µí¬íƒ„: ${gameState.magazine.filter(b => !b).length})`;

            let knownShotText = 'ì •ë³´ ì—†ìŒ';
            if (gameState.knownNextShot !== null) {
                knownShotText = gameState.knownNextShot ? 'ì‹¤íƒ„ ğŸ”´' : 'ê³µí¬íƒ„ ğŸŸ¡';
            }
            document.getElementById('known-next-shot').textContent = `ë‹¤ìŒ íƒ„í™˜ ì •ë³´: ${knownShotText}`;

            const activeEffects = [];
            if(gameState.playerProtected) activeEffects.push('P-ë°©íƒ„');
            if(gameState.dealerProtected) activeEffects.push('D-ë°©íƒ„');
            if(gameState.playerSawActive) activeEffects.push('P-ì‡ í†±(2X)');
            if(gameState.dealerSawActive) activeEffects.push('D-ì‡ í†±(2X)');
            if(gameState.dealerSkipNextTurn) activeEffects.push('D-ìˆ˜ê°‘');
            if(gameState.playerSkipNextTurn) activeEffects.push('P-ìˆ˜ê°‘');
            if(gameState.playerDamageFixToOne) activeEffects.push('P-ë¶€ì (1)');
            if(gameState.playerDamageAddOne) activeEffects.push('P-ë™ì „(+1)');
            if(gameState.dealerDamageAddOne) activeEffects.push('D-ë™ì „(+1)');
            gameState.knownBulletInfo.forEach(info => {
                activeEffects.push(`ğŸ“±(${info.index + 1}T:${info.isLive ? 'ğŸ”´' : 'ğŸŸ¡'})`);
            });
            document.getElementById('active-effects').textContent = `í™œì„±í™”ëœ íš¨ê³¼: ${activeEffects.length > 0 ? activeEffects.join(', ') : 'ì—†ìŒ'}`;


            // 2. ì•„ì´í…œ ë Œë”ë§ (8ê°œ ìŠ¬ë¡¯ ê³ ì •)
            [
                { container: dealerItemsContainer, items: gameState.dealerItems, type: 'dealer', color: 'red-500' },
                { container: playerItemsContainer, items: gameState.playerItems, type: 'player', color: 'green-500' }
            ].forEach(({ container, items, type, color }) => {
                container.innerHTML = '';
                // ì´ 8ê°œì˜ ìŠ¬ë¡¯ì„ ê°•ì œ ë Œë”ë§
                for (let i = 0; i < MAX_ITEM_SLOTS; i++) {
                    const item = items[i];
                    const isEmpty = item === undefined;
                    const itemElement = document.createElement('div');
                    const currentItem = isEmpty ? 'ë¹ˆ ìŠ¬ë¡¯' : item;
                    const itemIcon = isEmpty ? 'â¬œ' : ITEM_ICONS[currentItem] || 'â“'; // ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°

                    itemElement.className = `item-card rounded-lg p-3 shadow-lg flex flex-col justify-between items-center ${isEmpty ? 'empty' : `hover:border-${color}`}`;

                    // í”Œë ˆì´ì–´ í„´ì¼ ë•Œë§Œ ì•„ì´í…œ í´ë¦­ ê°€ëŠ¥
                    if (type === 'player' && !isEmpty && gameState.turn === 'player') {
                        itemElement.setAttribute('onclick', `GameModule.handleItemClick('${currentItem}', '${type}', ${i})`);
                    } else if (type === 'player' && gameState.turn !== 'player' && !isEmpty) {
                        itemElement.removeAttribute('onclick');
                        itemElement.style.cursor = 'default';
                        itemElement.style.opacity = '0.7';
                    }

                    itemElement.innerHTML = `
                    <span class="text-3xl">${itemIcon}</span>
                    <p class="text-sm font-bold text-center mt-2">${isEmpty ? 'EMPTY' : currentItem}</p>
                    <p class="text-xs text-gray-400 text-center mt-1">${isEmpty ? '' : ITEM_EFFECTS[currentItem] || '?'}</p>
                `;
                    container.appendChild(itemElement);
                }
            });

            // 3. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ë Œë”ë§
            // 3-1. ì‹œì‘/ì¬ì‹œì‘ ë²„íŠ¼
            let buttonText = 'ê²Œì„ ì‹œì‘';
            if (gameState.turn === 'end') {
                buttonText = 'ìƒˆ ê²Œì„ ì‹œì‘';
            }

            controlsStartElement.innerHTML = `
                <button onclick="GameModule.startGame()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200">
                    ${buttonText}
                </button>
            `;
            if (gameState.turn === 'end' || gameState.currentPage === 0) {
                controlsStartElement.classList.remove('hidden');
            } else {
                controlsStartElement.classList.add('hidden');
            }


            // 3-2. ì‚¬ê²© ë²„íŠ¼ (ê²Œì„ ê¸°ë¡ ì•„ë˜ì— ìœ„ì¹˜)
            controlsShotElement.innerHTML = '';
            if (gameState.turn === 'player' && gameState.playerHP > 0 && gameState.dealerHP > 0 && gameState.magazine.length > 0) {
                controlsShotElement.innerHTML = `
        <button onclick="GameModule.shotgunAction('dealer')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200">
            ë”œëŸ¬ì—ê²Œ ì‚¬ê²©
        </button>
        <button onclick="GameModule.shotgunAction('player')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200">
            ìì‹ ì—ê²Œ ì‚¬ê²©
        </button>
    `;
            } else if (gameState.turn === 'dealer' && gameState.magazine.length > 0 && gameState.playerHP > 0 && gameState.dealerHP > 0) {
                controlsShotElement.innerHTML = `<p class="text-lg text-red-500 text-center font-bold">ë”œëŸ¬ ğŸ¤– í„´ ì§„í–‰ ì¤‘...</p>`;
            } else {
                controlsShotElement.innerHTML = `<p class="text-sm text-gray-400 text-center">ê²Œì„ì„ ì‹œì‘í•˜ê±°ë‚˜, í„´ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.</p>`;
            }

        }

        // --- 6. ê³µê°œ API ---

        /**
         * ì•„ì´í…œ ì¹´ë“œ í´ë¦­ í•¸ë“¤ëŸ¬ (Public)
         */
        async function handleItemClick(item, type, index) {
            if (type === 'dealer' || gameState.turn !== 'player' || item === 'ë¹ˆ ìŠ¬ë¡¯') return;

            // ì•„ì´í…œ ì‚¬ìš©
            await usePlayerItem(item, index);
        }

        /**
         * ê²Œì„ ì‹œì‘/ì´ˆê¸°í™” ë° ë‹¤ìŒ ë¼ìš´ë“œ ì§„ì… (Public)
         */
        async function startGame() {
            // ğŸ’¡ [ìˆ˜ì •] ì²« ì‹œì‘ (currentPage=0)ì´ë©´ì„œ ëŠ¥ë ¥ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
            if (gameState.currentPage === 0 && gameState.selectedPerk === null) {
                // ëŠ¥ë ¥ì„ ì•„ì§ ì„ íƒí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ íƒ ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
                showPerkSelectionModal();
                return; // ëª¨ë‹¬ì„ ë„ì› ìœ¼ë‹ˆ ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
            }

            // ì´ ì•„ë˜ ë¡œì§ì€ ëª¨ë‹¬ì—ì„œ ëŠ¥ë ¥ì„ ì„ íƒí•œ ì§í›„ (selectedPerk !== null) ë˜ëŠ”
            // ê²Œì„ ì¢…ë£Œ í›„ ì¬ì‹œì‘ (turn === 'end') ì‹œì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.

            // 1 ì›¨ì´ë¸Œë¡œ ì´ˆê¸°í™”
            gameState.currentPage = 1;
            setupNewRound(); // HP, ì•„ì´í…œ, íƒ„ì°½ ëª¨ë‘ ì´ˆê¸°í™”
            outputElement.innerHTML = ''; // ì¶œë ¥ ì´ˆê¸°í™”

            const roundSettings = PAGE_SETTINGS[gameState.currentPage];

            // ğŸ’¡ íŠ¹ìˆ˜ ëŠ¥ë ¥ ì ìš© í™•ì¸ ë¬¸êµ¬ ì¶”ê°€
            let perkMessage = '';
            if (gameState.selectedPerk) {
                perkMessage = `(ëŠ¥ë ¥: ${PERKS[gameState.selectedPerk].name} ì ìš© ì™„ë£Œ)`;
            }

            await slowPrint(`ğŸ‰ ë£°ë › ê²Œì„ ì‹œì‘! (1 ì›¨ì´ë¸Œ) ${perkMessage}`);
            await slowPrint(`ğŸ˜ í”Œë ˆì´ì–´ HP: ${gameState.playerHP} | ğŸ¤– ë”œëŸ¬ HP: ${gameState.dealerHP}`);
            await slowPrint(`íƒ„ì°½ì„ ì„ì—ˆìŠµë‹ˆë‹¤. ${roundSettings.bulletText}ì´(ê°€) ì¥ì „ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // 3. UI ë Œë”ë§
            gameState.turn = 'player'; // ì›¨ì´ë¸Œ ì‹œì‘ ì‹œ í•­ìƒ í”Œë ˆì´ì–´ í„´
            renderUI();
            await slowPrint("\ní”Œë ˆì´ì–´ì˜ í„´ì…ë‹ˆë‹¤. ì‚¬ê²© ë˜ëŠ” ì•„ì´í…œì„ ì‚¬ìš©í•˜ì„¸ìš”.");
        }

        // ì™¸ë¶€ì— ê³µê°œí•  í•¨ìˆ˜ë“¤ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        return {
            startGame,
            shotgunAction,
            handleItemClick,
            renderUI, // ì´ˆê¸° ë Œë”ë§ì„ ìœ„í•´ ë…¸ì¶œ
            selectPerk
        };
    })();

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° UI ë Œë”ë§
    window.onload = () => {
        GameModule.renderUI();
    };
</script>

<div id="perk-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-lg w-full border border-red-500">
        <h2 class="text-2xl font-bold text-red-400 mb-6 text-center">ğŸŒŸ íŠ¹ìˆ˜ ëŠ¥ë ¥ ì„ íƒ ğŸŒŸ</h2>

        <div id="perk-options" class="space-y-4">
        </div>

        <p class="text-sm text-gray-400 mt-6 text-center">ì„ íƒí•œ ëŠ¥ë ¥ì€ ëª¨ë“  ì›¨ì´ë¸Œì— ì ìš©ë©ë‹ˆë‹¤.</p>
    </div>
</div>

</body>
</html>